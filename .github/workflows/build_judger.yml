name: Publish to docker registry

on:
  push:
    branches:
      - master

concurrency:
  group: publish-judger-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 180
    env:
      IMAGE_REGISTRY: ryanlee2014

    steps:
      - uses: actions/checkout@v4
        name: Checkout code
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
      - name: Build env
        run: |
          echo "PKG_VERSION=$(cat docker/judger/VERSION)" >> $GITHUB_ENV
          echo "PKG_FULL_VERSION=$(cat docker/judger/VERSION)-full" >> $GITHUB_ENV
      - name: Validate image tag version
        run: |
          if [ -z "${PKG_VERSION}" ] || [ -z "${PKG_FULL_VERSION}" ]; then
            echo "PKG_VERSION or PKG_FULL_VERSION is empty"
            exit 1
          fi
          echo "PKG_VERSION=${PKG_VERSION}"
          echo "PKG_FULL_VERSION=${PKG_FULL_VERSION}"
          echo "Git SHA: $(git rev-parse --short HEAD)"
          echo "Run timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push base judger service image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          file: ./docker/judger/base/Dockerfile
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ${{ env.IMAGE_REGISTRY }}/cupoj-judger:${{ env.PKG_VERSION }}
            ${{ env.IMAGE_REGISTRY }}/cupoj-judger:latest
      - name: Build and push full judger service image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          file: ./docker/judger/full/Dockerfile
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ env.IMAGE_REGISTRY }}/cupoj-judger:${{ env.PKG_FULL_VERSION }}
